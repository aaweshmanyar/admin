<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ایڈمن پینل - مسائل ورلڈ</title>
  <meta name="description" content="مسائل ورلڈ کے لیے ایڈمن پینل - فتاویٰ، مضامین، کتابیں، اور بہت کچھ کا نظم کریں۔">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jameel+Noori+Nastaleeq&family=Lateef&family=Scheherazade+New&display=swap" rel="stylesheet">

  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    @font-face {
      font-family: 'NaatFont';
      src: url('https://res.cloudinary.com/awescreative/raw/upload/v1749150996/Awes/naatfont.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body { font-family: 'NaatFont', serif; font-size: 80%; overscroll-behavior: none; background:#f3f4f6; padding:18px; }
    .card{ margin: 20px auto; max-width: 1100px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .qalam-tag-pill{ background-color:#124559;color:white;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;margin:4px 6px;gap:8px; font-size:14px; }
    .qalam-tag-remove-btn{ cursor:pointer; font-weight:bold; border:0; background:transparent; color:#ffd9d9; padding:0 4px; }
    .ql-editor{ min-height:250px; font-family:'Jameel Noori+Nastaleeq',serif; font-size:18px; direction:rtl; text-align:right }
    .hidden{ display:none !important }
    /* ensure container keeps input at end and wraps pills */
    .as-tag-input-container{ min-height:48px; display:flex; flex-wrap:wrap; align-items:center; gap:6px; padding:8px; }
    .as-tag-input-field{ min-width:120px; border:0; outline:0; padding:8px 4px; background:transparent; font-size:16px; color:#0f172a }
  </style>
</head>

<body class="bg-gray-100">

  <div class="as-admin-page qalam-admin-page max-w-4xl mx-auto py-8">
    <div class="flex justify-between items-center mb-8">
      <h1 id="edit-ulema-form-title" class="text-3xl md:text-4xl font-bold text-midnight_green">
        عالم کی ترمیم کریں
      </h1>
      <a href="ManageUlema.html"
         class="as-back-link as-admin-nav-link flex items-center text-lg text-midnight_green hover:text-rich_black transition">
        <i class="bi bi-arrow-right ml-2"></i>
        فہرست پر واپس جائیں
      </a>
    </div>

    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
      <form id="edit-ulema-form" class="space-y-6">
        <input type="hidden" id="edit-ulema-id">

        <div>
          <label for="edit-ulema-name" class="block text-xl font-bold text-midnight_green mb-2">نام</label>
          <input type="text" id="edit-ulema-name"
                 class="w-full py-3 px-4 border-2 border-ash_gray rounded-lg focus:outline-none focus:ring-2 focus:ring-midnight_green text-rich_black text-lg"
                 required>
        </div>

        <div>
          <label for="edit-ulema-designation" class="block text-xl font-bold text-midnight_green mb-2">عہدہ</label>
          <input type="text" id="edit-ulema-designation"
                 class="w-full py-3 px-4 border-2 border-ash_gray rounded-lg focus:outline-none focus:ring-2 focus:ring-midnight_green text-rich_black text-lg"
                 required>
        </div>

        <div>
          <label for="edit-ulema-photo" class="block text-xl font-bold text-midnight_green mb-2">تصویر</label>
          <input type="file" id="edit-ulema-photo"
                 class="w-full text-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-beige file:text-midnight_green hover:file:bg-ash_gray">
          <div class="mt-2">
            <img id="edit-ulema-preview" src="" alt="Profile Preview" class="h-24 rounded border">
          </div>
        </div>

        <div>
          <label for="edit-ulema-bio" class="block text-xl font-bold text-midnight_green mb-2">مختصر تعارف</label>
          <div id="edit-ulema-bio" class="qalam-rich-text-editor border border-black"></div>
        </div>

        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 md:space-x-reverse pt-4">
          <button type="submit"
                  class="w-full md:w-auto bg-midnight_green text-white py-3 px-8 rounded-lg text-lg bg-gray-800 transition">
            اپڈیٹ کریں
          </button>
          <a href="index.html"
             class="w-full md:w-auto bg-ash_gray text-white py-3 px-8 rounded-lg text-lg bg-gray-800 transition text-center">
            منسوخ کریں
          </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api/aleem";

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!id) {
        alert("❌ ID مہیا نہیں کیا گیا");
        window.location.href = "ManageUlema.html";
        return;
      }
      loadAleem(id);
      setupEditForm(id);
    });

    async function loadAleem(id) {
      try {
        const res = await fetch(`${API_URL}/${id}`);
        if (!res.ok) throw new Error("Failed to load data");
        const ulema = await res.json();

        document.getElementById("edit-ulema-id").value = ulema.id;
        document.getElementById("edit-ulema-name").value = ulema.Name || "";
        document.getElementById("edit-ulema-designation").value = ulema.Position || "";
        document.getElementById("edit-ulema-bio").innerHTML = ulema.About || "";

        // Load profile preview
        const imgRes = await fetch(`${API_URL}/${id}/profile`);
        if (imgRes.ok) {
          const blob = await imgRes.blob();
          document.getElementById("edit-ulema-preview").src = URL.createObjectURL(blob);
        }
      } catch (err) {
        console.error("❌ loadAleem error:", err);
        alert("❌ ڈیٹا لوڈ نہیں ہوسکا");
      }
    }

    function setupEditForm(id) {
      const form = document.getElementById("edit-ulema-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nameVal = document.getElementById("edit-ulema-name").value.trim();
        const positionVal = document.getElementById("edit-ulema-designation").value.trim();
        const aboutHtml = document.getElementById("edit-ulema-bio").innerHTML.trim();
        const photoInput = document.getElementById("edit-ulema-photo");

        const formData = new FormData();
        formData.append("Name", nameVal);
        formData.append("Position", positionVal);
        formData.append("About", aboutHtml);

        if (photoInput && photoInput.files && photoInput.files[0]) {
          formData.append("ProfileImg", photoInput.files[0]);
        }

        try {
          const res = await fetch(`${API_URL}/${id}`, {
            method: "PUT",
            body: formData
          });

          if (!res.ok) throw new Error(`Update failed: ${res.status}`);
          alert("✅ انٹری اپڈیٹ ہوگئی");
          window.location.href = "../index.html#manage-ulema";
        } catch (err) {
          console.error("❌ updateAleem error:", err);
          alert("❌ اپڈیٹ نہیں ہوسکا");
        }
      });
    }
  </script>
</body>
</html>
